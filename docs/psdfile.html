<!DOCTYPE html>  <html> <head>   <title>psdfile.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="log.html">                 log.coffee               </a>                                           <a class="source" href="psd.html">                 psd.coffee               </a>                                           <a class="source" href="psdfile.html">                 psdfile.coffee               </a>                                           <a class="source" href="psdheader.html">                 psdheader.coffee               </a>                                           <a class="source" href="psdimage.html">                 psdimage.coffee               </a>                                           <a class="source" href="psdlayer.html">                 psdlayer.coffee               </a>                                           <a class="source" href="psdlayereffect.html">                 psdlayereffect.coffee               </a>                                           <a class="source" href="psdlayermask.html">                 psdlayermask.coffee               </a>                                           <a class="source" href="psdresource.html">                 psdresource.coffee               </a>                                           <a class="source" href="psdtypetool.html">                 psdtypetool.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               psdfile.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Simulation and abstraction of a disk-based file.
Provides methods to read the raw binary file data, which is stored in a 
variable instead of read from disk. A lot of these functions are from C,
but some of them are helper functions to make things a bit easier to
understand.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">PSDFile</span>
  <span class="nv">constructor: </span><span class="nf">(@data) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Track our current position in the file data. This is analogous to the
file pointer in C.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@pos = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Get the current position in the file. This is here to parallel the C method</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">tell: </span><span class="o">-&gt;</span> <span class="nx">@pos</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Read one or more bytes from the file. Note that this moves the file pointer
forward the number of bytes specified.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">read: </span><span class="nf">(bytes) -&gt;</span> <span class="p">(</span><span class="nx">@data</span><span class="p">[</span><span class="nx">@pos</span><span class="o">++</span><span class="p">]</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">bytes</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Move the file pointer to a new position. By default, this is done relative
to the current file pointer position. Setting the 2nd argument to false
causes the file pointer to move to the absolute location specified.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">seek: </span><span class="nf">(amount, rel = true) -&gt;</span>
    <span class="k">if</span> <span class="nx">rel</span> <span class="k">then</span> <span class="nx">@pos</span> <span class="o">+=</span> <span class="nx">amount</span> <span class="k">else</span> <span class="vi">@pos = </span><span class="nx">amount</span>
      </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Helper function to read an unsigned 16-bit integer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readUInt16: </span><span class="o">-&gt;</span>
    <span class="nv">b1 = </span><span class="nx">@data</span><span class="p">[</span><span class="nx">@pos</span><span class="o">++</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
    <span class="nv">b2 = </span><span class="nx">@data</span><span class="p">[</span><span class="nx">@pos</span><span class="o">++</span><span class="p">]</span>
    <span class="nx">b1</span> <span class="o">|</span> <span class="nx">b2</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Helper functions so we don't have to remember the unpack
format codes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>4 bytes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readInt: </span><span class="o">-&gt;</span> <span class="nx">@readf</span><span class="p">(</span><span class="s2">&quot;&gt;i&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">readUInt: </span><span class="o">-&gt;</span> <span class="nx">@readf</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>2 bytes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readShortInt: </span><span class="o">-&gt;</span> <span class="nx">@readf</span><span class="p">(</span><span class="s2">&quot;&gt;h&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">readShortUInt: </span><span class="o">-&gt;</span> <span class="nx">@readf</span><span class="p">(</span><span class="s2">&quot;&gt;H&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>4 bytes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readLongInt: </span><span class="o">-&gt;</span> <span class="nx">@readf</span><span class="p">(</span><span class="s2">&quot;&gt;l&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">readLongUInt: </span><span class="o">-&gt;</span> <span class="nx">@readf</span><span class="p">(</span><span class="s2">&quot;&gt;L&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>8 bytes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readDouble: </span><span class="o">-&gt;</span> <span class="nx">@readf</span><span class="p">(</span><span class="s2">&quot;&gt;d&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>1 byte</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readBoolean: </span><span class="o">-&gt;</span> <span class="nx">@read</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">isnt</span> <span class="mi">0</span>

  <span class="nv">readUnicodeString: </span><span class="nf">(strlen = null) -&gt;</span>
    <span class="nv">str = </span><span class="s2">&quot;&quot;</span>
    <span class="nv">strlen = </span><span class="nx">@readUInt</span><span class="p">()</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">strlen</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">strlen</span><span class="p">]</span>
      <span class="nv">charCode = </span><span class="nx">@readShortUInt</span><span class="p">()</span>
      <span class="nx">str</span> <span class="o">+=</span> <span class="nx">chr</span><span class="p">(</span><span class="nx">Util</span><span class="p">.</span><span class="nx">i16</span><span class="p">(</span><span class="nx">charCode</span><span class="p">))</span> <span class="k">if</span> <span class="nx">charCode</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Parses the structure of a descriptor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readDescriptorStructure: </span><span class="o">-&gt;</span>
    <span class="nv">name = </span><span class="nx">@readUnicodeString</span><span class="p">()</span>
    <span class="nv">classID = </span><span class="nx">@readLengthWithString</span><span class="p">()</span>
    <span class="nv">items = </span><span class="nx">@readUInt</span><span class="p">()</span>

    <span class="nv">descriptors = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">items</span><span class="p">]</span>
      <span class="nv">key = </span><span class="nx">@readLengthWithString</span><span class="p">().</span><span class="nx">trim</span><span class="p">()</span>
      <span class="nx">descriptors</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@readOsType</span><span class="p">()</span>

    <span class="nx">descriptors</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Reads a string with the given length. Note that the length is given in 
bytes, not characters.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readString: </span><span class="nf">(length) -&gt;</span> <span class="nx">@readf</span><span class="p">(</span><span class="s2">&quot;&gt;#{length}s&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Used for reading pascal strings, which are strings that have their length 
prepended to the chunk of character bytes. If a length isn't found, a 
string with the default length will be read instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readLengthWithString: </span><span class="nf">(defaultLen = 4) -&gt;</span>
    <span class="nv">length = </span><span class="nx">@read</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nv">str = </span><span class="nx">@readString</span> <span class="nx">defaultLen</span>
    <span class="k">else</span>
      <span class="nv">str = </span><span class="nx">@readString</span> <span class="nx">length</span>

    <span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Parses a special OS variable type</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readOsType: </span><span class="o">-&gt;</span>
    <span class="nv">osType = </span><span class="nx">@readString</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="nv">value = </span><span class="kc">null</span>
    <span class="k">switch</span> <span class="nx">osType</span>
      <span class="k">when</span> <span class="s2">&quot;TEXT&quot;</span> <span class="k">then</span> <span class="nv">value = </span><span class="nx">@readUnicodeString</span><span class="p">()</span>
      <span class="k">when</span> <span class="s2">&quot;enum&quot;</span><span class="p">,</span> <span class="s2">&quot;Objc&quot;</span><span class="p">,</span> <span class="s2">&quot;GlbO&quot;</span>
        <span class="nv">value =</span>
          <span class="nv">typeID: </span><span class="nx">@readLengthWithString</span><span class="p">()</span>
          <span class="nv">enum: </span><span class="nx">@readLengthWithString</span><span class="p">()</span>
      <span class="k">when</span> <span class="s2">&quot;VlLs&quot;</span>
        <span class="nv">listSize = </span><span class="nx">@readUInt</span><span class="p">()</span>
        <span class="nv">value = </span><span class="p">[]</span>
        <span class="nx">value</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@readOsType</span><span class="p">())</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">listSize</span><span class="p">]</span>
      <span class="k">when</span> <span class="s2">&quot;doub&quot;</span> <span class="k">then</span> <span class="nv">value = </span><span class="nx">@readDouble</span><span class="p">()</span>
      <span class="k">when</span> <span class="s2">&quot;UntF&quot;</span>
        <span class="nv">value =</span>
          <span class="nv">type: </span><span class="nx">@readString</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
          <span class="nv">value: </span><span class="nx">@readDouble</span><span class="p">()</span>
      <span class="k">when</span> <span class="s2">&quot;long&quot;</span> <span class="k">then</span> <span class="nv">value = </span><span class="nx">@readUInt</span><span class="p">()</span>
      <span class="k">when</span> <span class="s2">&quot;bool&quot;</span> <span class="k">then</span> <span class="nv">value = </span><span class="nx">@readBoolean</span><span class="p">()</span>
      <span class="k">when</span> <span class="s2">&quot;alis&quot;</span>
        <span class="nv">length = </span><span class="nx">@readUInt</span><span class="p">()</span>
        <span class="nv">value = </span><span class="nx">@readString</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span>
      <span class="k">when</span> <span class="s2">&quot;obj&quot;</span>
        <span class="nv">num = </span><span class="nx">@readUInt</span><span class="p">()</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">num</span><span class="p">]</span>
          <span class="nv">type = </span><span class="nx">@readString</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
          <span class="k">switch</span> <span class="nx">type</span>
            <span class="k">when</span> <span class="s2">&quot;prop&quot;</span>
              <span class="nv">value =</span>
                <span class="nv">name: </span><span class="nx">@readUnicodeString</span><span class="p">()</span>
                <span class="nv">classID: </span><span class="nx">@readLengthWithString</span><span class="p">()</span>
                <span class="nv">keyID: </span><span class="nx">@readLengthWithString</span><span class="p">()</span>
            <span class="k">when</span> <span class="s2">&quot;Clss&quot;</span>
              <span class="nv">value =</span>
                <span class="nv">name: </span><span class="nx">@readUnicodeString</span><span class="p">()</span>
                <span class="nv">classID: </span><span class="nx">@readLengthWithString</span><span class="p">()</span>
            <span class="k">when</span> <span class="s2">&quot;Enmr&quot;</span>
              <span class="nv">value =</span>
                <span class="nv">name: </span><span class="nx">@readUnicodeString</span><span class="p">()</span>
                <span class="nv">classID: </span><span class="nx">@readLengthWithString</span><span class="p">()</span>
                <span class="nv">typeID: </span><span class="nx">@readLengthWithString</span><span class="p">()</span>
                <span class="nv">enum: </span><span class="nx">@readLengthWithString</span><span class="p">()</span>
            <span class="k">when</span> <span class="s2">&quot;rele&quot;</span>
              <span class="nv">value =</span>
                <span class="nv">name: </span><span class="nx">@readUnicodeString</span><span class="p">()</span>
                <span class="nv">classID: </span><span class="nx">@readLengthWithString</span><span class="p">()</span>
                <span class="nv">offsetValue: </span><span class="nx">@readUInt</span><span class="p">()</span>
            <span class="k">when</span> <span class="s2">&quot;Idnt&quot;</span><span class="p">,</span> <span class="s2">&quot;indx&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="k">then</span> <span class="nv">value = </span><span class="kc">null</span>
      <span class="k">when</span> <span class="s2">&quot;tdta&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Skip this</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">length = </span><span class="nx">@readUInt</span><span class="p">()</span>
        <span class="nx">@seek</span> <span class="nx">length</span>

    <span class="p">{</span><span class="nv">type: </span><span class="nx">osType</span><span class="p">,</span> <span class="nv">value: </span><span class="nx">value</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Reads a byte list</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readBytesList: </span><span class="nf">(size) -&gt;</span> <span class="nx">@read</span> <span class="nx">size</span>
  </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Reads from the file given the unpack format string. Format string codes 
can be easily referenced 
<a href="http://docs.python.org/library/struct.html#format-characters">from the Python docs</a></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readf: </span><span class="nf">(format) -&gt;</span> <span class="nx">jspack</span><span class="p">.</span><span class="nx">Unpack</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">@read</span><span class="p">(</span><span class="nx">jspack</span><span class="p">.</span><span class="nx">CalcLength</span><span class="p">(</span><span class="nx">format</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Skips a block, assuming the next byte describes the size of the section.
An optional description is given to explain why we are skipping this block
instead of parsing it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">skipBlock: </span><span class="nf">(desc = &quot;unknown&quot;) -&gt;</span>
    <span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@readf</span><span class="p">(</span><span class="s1">&#39;&gt;L&#39;</span><span class="p">)</span>
    <span class="nx">@seek</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="nx">n</span> <span class="c1"># relative</span>

    <span class="nx">Log</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Skipped #{desc} with #{n} bytes&quot;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 